<!-- templates/twitter_manager.html -->
{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-[#A4A5A6] py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-black rounded-lg shadow-lg border border-gray-800 p-6">
            <h1 class="text-2xl font-bold text-[#A4A5A6] mb-6">Twitter Manager</h1>
            
            <div class="space-y-6">
                <!-- Connection Status -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full {{ 'bg-green-500' if is_connected else 'bg-red-500' }}"></div>
                        <span class="text-[#A4A5A6]">{{ 'Connected' if is_connected else 'Disconnected' }}</span>
                    </div>
                    
                    {% if is_connected %}
                        <button onclick="disconnectTwitter()" 
                                class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                            Disconnect
                        </button>
                    {% else %}
                        <a href="{{ url_for('twitter_auth') }}" 
                           class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Connect Twitter
                        </a>
                    {% endif %}
                </div>

                <!-- Next Post Timer -->
                <div class="mt-4 text-sm text-[#A4A5A6]">
                    Next Twitter post in: <span id="twitter-countdown" class="font-bold">00:00</span>
                </div>

                {% if error %}
                <div class="mt-4 text-sm text-red-500">
                    {{ error }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function disconnectTwitter() {
    if (confirm('Are you sure you want to disconnect your Twitter account?')) {
        // Add disconnect functionality
        window.location.reload();
    }
}

function initializeTwitterCountdown() {
    const nextPost = new Date("{{ next_twitter_post }}");
    const serverTime = new Date("{{ server_time }}");  // Add this to your template context
    const localTime = new Date();
    const timeDiff = localTime - serverTime;  // Time difference between local and server
    let countdownInterval;

    function updateCountdown() {
        const now = new Date();
        const adjustedNow = new Date(now.getTime() - timeDiff);  // Adjust for server time
        const timeLeft = nextPost - adjustedNow;

        if (timeLeft <= 0) {
            clearInterval(countdownInterval);
            location.reload();
            return;
        }

        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);
        
        const timerElement = document.getElementById('twitter-countdown');
        if (timerElement) {
            timerElement.textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
    }

    // Update immediately and then every second
    updateCountdown();
    countdownInterval = setInterval(updateCountdown, 1000);

    // Cleanup on page unload
    window.addEventListener('unload', () => {
        clearInterval(countdownInterval);
    });
}

// Initialize once when document loads
document.addEventListener('DOMContentLoaded', initializeTwitterCountdown);
</script>
{% endblock %}